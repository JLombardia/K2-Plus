#####################################################################
# "HORIZON" MANUAL LEVELING MACROS - CREALITY K2 PLUS
#####################################################################

[gcode_macro _HORIZON_VARS]
description: Configuration variables for manual leveling
variable_screw_pitch: 0.7     # Screw pitch (M4 is usually 0.7mm). Change to 0.5 for M3.
variable_z_tolerance: 2.0     # Tolerance limit in mm to trigger a reset warning
# Screw Coordinates (Estimated for K2 Plus 350x350 bed).
# Ensure the PROBE (not just the nozzle) is over these points.
variable_pos_fl: 40, 40       # Front Left (Reference Point)
variable_pos_fr: 310, 40      # Front Right
variable_pos_rl: 40, 310      # Rear Left
variable_pos_rr: 310, 310     # Rear Right
variable_ref_z: 0.0           # Internal variable to store reference height
gcode:
    # This macro does not execute commands, it only stores variables.

[gcode_macro _HORIZON_REFERENCE]
description: (Internal) Measures the Z-height at the FL reference point
gcode:
    {% set vars = printer["gcode_macro _HORIZON_VARS"] %}
    
    # Home axes if not already homed
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    # Move to FL position (Reference)
    G90
    G0 Z10 F1500
    G0 X{vars.pos_fl[0]} Y{vars.pos_fl[1]} F6000
    
    # Measure
    PROBE
    
    # Save the Z result to the global variable
    SET_GCODE_VARIABLE MACRO=_HORIZON_VARS VARIABLE=ref_z VALUE={printer.probe.last_z}
    M118 FL Reference taken: {printer.probe.last_z}mm

[gcode_macro HORIZON_1_RR]
description: Measures FL Reference, then adjusts Rear Right (RR)
gcode:
    _HORIZON_LOGIC TARGET="RR"

[gcode_macro HORIZON_2_RL]
description: Measures FL Reference, then adjusts Rear Left (RL)
gcode:
    _HORIZON_LOGIC TARGET="RL"

[gcode_macro HORIZON_3_FR]
description: Measures FL Reference, then adjusts Front Right (FR)
gcode:
    # Note: User requested FL in prompt logic, but since FL is the reference, 
    # we adjust FR (Front Right) to match FL.
    _HORIZON_LOGIC TARGET="FR"

[gcode_macro _HORIZON_LOGIC]
description: Core logic to calculate screw turns based on clock positions
gcode:
    {% set target = params.TARGET %}
    {% set vars = printer["gcode_macro _HORIZON_VARS"] %}
    
    # 1. Always take a fresh Reference at FL first
    _HORIZON_REFERENCE
    
    # Reload variable (ref_z is updated now)
    {% set ref = printer["gcode_macro _HORIZON_VARS"].ref_z %}
    
    # 2. Move to Target
    G90
    G0 Z10 F1500
    {% if target == "RR" %}
        G0 X{vars.pos_rr[0]} Y{vars.pos_rr[1]} F6000
    {% elif target == "RL" %}
        G0 X{vars.pos_rl[0]} Y{vars.pos_rl[1]} F6000
    {% elif target == "FR" %}
        G0 X{vars.pos_fr[0]} Y{vars.pos_fr[1]} F6000
    {% endif %}
    
    # 3. Measure Target
    PROBE
    {% set current_z = printer.probe.last_z %}
    {% set diff = current_z - ref %}
    
    # 4. Calculations
    # If diff is positive (e.g., 0.5), the corner is HIGH. We need to lower it (Tighten/Screw).
    # If diff is negative (e.g., -0.5), the corner is LOW. We need to raise it (Loosen/Unscrew).
    
    {% set abs_diff = diff|abs %}
    
    # Visual separator for console
    M118 ----------------------------------------
    M118 Adjustment for corner {target}:
    
    # 5. Safety Range Check
    {% if abs_diff > vars.z_tolerance %}
        # Out of range
        {% if diff > 0 %}
             M118 DANGER: Too High ({diff|round(3)}mm).
             M118 ACTION: SCREW (Tighten) FL one full turn because it is out of range, then restart.
        {% else %}
             M118 DANGER: Too Low ({diff|round(3)}mm).
             M118 ACTION: UNSCREW (Loosen) FL one full turn because it is out of range, then restart.
        {% endif %}
    {% else %}
        # Clock position calculation
        # Positions = (Difference / Pitch) * 12
        {% set positions = (abs_diff / vars.screw_pitch * 12)|round|int %}
        
        {% if positions == 0 %}
             M118 PERFECT. No adjustment needed.
        {% elif diff > 0 %}
             # High -> Needs to go down -> Tighten
             M118 ACTION: SCREW (Tighten/Right) -> {positions} positions (hours).
        {% else %}
             # Low -> Needs to go up -> Loosen
             M118 ACTION: UNSCREW (Loosen/Left) -> {positions} positions (hours).
        {% endif %}
    {% endif %}
    M118 ----------------------------------------
