# Internal macro (hidden) to handle safe travel between points
[gcode_macro _NUT_MOVE]
gcode:
    {% set x = params.X|default(0)|float %}
    {% set y = params.Y|default(0)|float %}
    {% set z_height = 0.1 %}   ; Thickness of paper/feeler gauge

    G1 Z5 F3000                ; Lift Z for safe travel
    G1 X{x} Y{y} F6000         ; Move X/Y fast to target
    G1 Z{z_height} F300        ; Lower slowly to leveling height

# ======================================================================
# BED LEVELLING
# ======================================================================

[gcode_macro NUT_1_CENTER]
description: Starts the leveling process: Heats bed/nozzle, Homes, and prepares the machine.
gcode:
    # Default parameters (based on your original values)
    {% set bed_temp = params.BED|default(60)|int %}
    {% set ext_temp = params.EXTRUDER|default(225)|int %}

    M117 Heating for leveling...
    M140 S{bed_temp}      ; Set bed temp
    M104 S{ext_temp}      ; Set extruder temp
    
    # Conditional homing: Only homes if not already homed to save time
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    M190 S{bed_temp}      ; Wait for bed temp
    M109 S{ext_temp}      ; Wait for extruder temp
    
    BED_MESH_CLEAR        ; Clear previous meshes to ensure accuracy
    G90                   ; Absolute positioning
    G21                   ; Millimeter units
    
    # Move to initial center position
    _NUT_MOVE X=175 Y=175

[gcode_macro NUT_2_LEFT_FRONT]
description: Move to Front Left Corner
gcode:
    _NUT_MOVE X=50 Y=50

[gcode_macro NUT_3_RIGHT_REAR]
description: Move to Rear Right Corner
gcode:
    _NUT_MOVE X=300 Y=300

[gcode_macro NUT_4_RIGHT_FRONT]
description: Move to Front Right Corner
gcode:
    _NUT_MOVE X=300 Y=50

[gcode_macro NUT_5_LEFT_REAR]
description: Move to Rear Left Corner
gcode:
    _NUT_MOVE X=50 Y=300 

[gcode_macro NUT_6_END]
description: Finish leveling, lift nozzle, and cool down.
gcode:
    G91              ; Relative positioning
    G1 Z10 F600      ; Lift Z 10mm
    G90              ; Absolute positioning
    G28 X Y          ; Park toolhead (Home X/Y)
    M140 S0          ; Turn off bed
    M104 S0          ; Turn off hotend
    M117 Leveling Finished.