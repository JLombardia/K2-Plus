[gcode_macro SET_USER_SKEW]
description: Configura el Skew. Pulsa la flecha para introducir AC, BD y AD. Es la rutina para guardar los valores
gcode:
    # Recogemos los parametros de la interfaz
    {% set ac = params.AC|default(0)|float %}
    {% set bd = params.BD|default(0)|float %}
    {% set ad = params.AD|default(0)|float %}
    
    # Comprobamos si has metido los datos
    {% if ac > 0 and bd > 0 and ad > 0 %}
        # Guardamos en el archivo permanente
        SAVE_VARIABLE VARIABLE=skew_ac VALUE={ac}
        SAVE_VARIABLE VARIABLE=skew_bd VALUE={bd}
        SAVE_VARIABLE VARIABLE=skew_ad VALUE={ad}
        
        {action_respond_info("✅ Skew Guardado Correctamente:")}
        {action_respond_info("AC: " ~ ac ~ " | BD: " ~ bd ~ " | AD: " ~ ad)}
        {action_respond_info("Se aplicará automáticamente en la próxima impresión.")}
        
        # Opcional: Calcular y mostrar el factor de correccion actual para curiosidad
        # (Esto es solo visual, Klipper hace el calculo real internamente)
    {% else %}
        # Si se te olvida poner los numeros, te avisa
        {action_respond_info("⚠️ ERROR: Faltan medidas.")}
        {action_respond_info("PISTA: No pulses el botón directo. Pulsa la flechita (v) e introduce los valores de AC, BD y AD.")}
        {action_respond_info("Ejemplo para Califlower: AC=141.42 BD=141.42 AD=100")}
    {% endif %}

[gcode_macro SET_MY_SKEW]
description: Aplica el Skew guardado en variables.cfg (Se ejecuta en PRINT_START)
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set ac = svv.skew_ac|default(0)|float %}
    {% set bd = svv.skew_bd|default(0)|float %}
    {% set ad = svv.skew_ad|default(0)|float %}

    {% if ac > 0 and bd > 0 and ad > 0 %}
        # Aplicamos la correccion XY basándonos en las medidas
        SET_SKEW XY={ac},{bd},{ad}
        {action_respond_info("Corrección de Skew activada (Medidas: AC="~ac~" BD="~bd~" AD="~ad~")")}
    {% else %}
        SET_SKEW CLEAR=1
        {action_respond_info("Skew desactivado (No hay medidas guardadas)")}
    {% endif %}
 
[gcode_macro CLEAR_MY_SKEW]
gcode:
  SET_SKEW CLEAR=1
